# Dockerfile.data: Data Processing Container (GPU-ready)
FROM nvidia/cuda:12.2.0-runtime-ubuntu22.04

# System dependencies
RUN apt-get update && apt-get install -y \
    python3.10 python3.10-venv python3.10-dev python3-pip \
    build-essential git wget curl \
    xvfb x11-utils && \
    rm -rf /var/lib/apt/lists/*

# Set python3.10 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1

# Create working directory
WORKDIR /workspace

# Copy requirements and install Python dependencies
COPY requirements.txt ./
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install -r requirements.txt

# Configure matplotlib for headless operation
RUN python3 -c "import matplotlib; matplotlib.use('Agg'); import matplotlib.pyplot as plt; plt.ioff()"

# Copy scripts (will be overridden by volume mount if present)
COPY scripts/ ./scripts/

# Make wrapper script executable
RUN chmod +x scripts/run_data_collection.sh

# Create a startup script that correctly handles dependencies
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Starting data service..."\n\
\n\
# Always install dependencies from the mounted requirements.txt\n\
if [ -f /workspace/requirements.txt ]; then\n\
    echo "ðŸ“¦ Installing Python dependencies from requirements.txt..."\n\
    pip install --no-cache-dir -r /workspace/requirements.txt\n\
else\n\
    echo "âš ï¸ requirements.txt not found. Skipping dependency installation."\n\
fi\n\
\n\
echo "âœ… Dependencies are up-to-date. Running data collection..."\n\
exec ./scripts/run_data_collection.sh "$@" \n\
' > /workspace/start.sh && \
    chmod +x /workspace/start.sh

# Entrypoint for data collection/processing
ENTRYPOINT ["/workspace/start.sh"] 